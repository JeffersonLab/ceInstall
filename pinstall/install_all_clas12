#!/bin/zsh -i

function testResult() {
	library=$1
	version=$2

	mtest=$(module test $library/$version | grep result | awk '{print $3}')

	echo $mtest
}


# parse argument. If no argument given, set version to all available
if [[ $# -eq 0 ]]; then
	physlibs_version=$( ls $(dirname "$(readlink -f "$0")")"/../modules/modulefiles/physlibs/" )
else
	physlibs_version=$1
fi


echo " > Availaible phys_versions: $=physlibs_version"
echo

for pv in  $=physlibs_version ; do

	echo " > Checking missing modules in physlibs version $pv"
	module unload physlibs     -s
	module load	  physlibs/$pv -s

	[[ $(testResult .clhep    $CLHEP_VERSION)    == "PASS" ]] && echo " > clhep is installed"    || install_clhep
	[[ $(testResult .xercesc  $XERCESC_VERSION)  == "PASS" ]] && echo " > xercesc is installed"  || install_xercesc
	[[ $(testResult .qt       $QT_VERSION)       == "PASS" ]] && echo " > qt is installed"       || copy_qt
	[[ $(testResult .geant4   $G4_VERSION)       == "PASS" ]] && echo " > geant4 is installed"   || install_geant4_data
	[[ $(testResult .geant4   $G4_VERSION)       == "PASS" ]] && echo " > geant4 is installed"   || install_geant4
	[[ $(testResult .scons_bm $SCONS_BM_VERSION) == "PASS" ]] && echo " > scons_bm is installed" || install_scons_bm
	[[ $(testResult .ccdb     $CCDB_VERSION)     == "PASS" ]] && echo " > ccdb is installed"     || install_ccdb
	[[ $(testResult .evio     $EVIO_VERSION)     == "PASS" ]] && echo " > evio is installed"     || install_evio
	[[ $(testResult .mlibrary $MLIBRARY_VERSION) == "PASS" ]] && echo " > mlibrary is installed" || install_mlibrary
	[[ $(testResult .hipo     $HIPO_VERSION)     == "PASS" ]] && echo " > hipo is installed"     || install_hipo

	echo
	module test physlibs/$pv

done
echo
