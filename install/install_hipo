#!/bin/zsh

# if the environment variables HIPO and HIPO_VERSION are not set, exit
if [[ -z "$HIPO" || -z "$HIPO_VERSION" ]]; then
	echo "$red > HIPO or HIPO_VERSION environment variables are not set. Exiting.$reset"
	exit 1
fi

what="hipo"
what_version="$HIPO_VERSION"
base_dir="$HIPO"
grepo="https://github.com/gavalian/hipo"
source_dir=hipo_source

source "$(dirname "$(readlink -f "$0")")"/functions.zsh

log_general "$what" "$what_version" "$grepo" "$base_dir"

echo hello
ls -l /.dockerenv
export


# if we are in a docker container temp hiding root
if [[ -n "$AUTOMATED_BUILD" ]]; then
	echo "$magenta > Running in a docker container. Temp hiding /usr/share/root by moving it $reset"
	mv /usr/share/root/ $SIM_INSTALLATION_DIR
fi

git clone --recurse-submodules --single-branch -b $what_version "$grepo" $source_dir
cd $source_dir || exit

# in a docker container, we need to build lz4.
if [[ -n "$AUTOMATED_BUILD" ]]; then
	cd lz4
	make PREFIX=$base_dir CFLAGS='-fPIC' install || exit
	cd ..
fi
mkdir build
cd build || exit

# if we are in a docker container restoring root
if [[ -n "$AUTOMATED_BUILD" ]]; then
	echo "$magenta > Running in a docker container. Restoring /usr/share/root $reset"
	mv $SIM_INSTALLATION_DIR/root /usr/share/root/
fi

cmake -DCMAKE_INSTALL_PREFIX=$base_dir ../
make -j "$n_cpu" install || exit
cd ../../ || exit
rm -rf $source_dir

# temp copying hipo4 from include until this is fixed in scons loadhipo,
# which looks things inside $HIPO/hipo4
cd "$base_dir" || exit
cp -r include/hipo4 ..
cp -r include/*.h hipo4
ls -l

echo "$magenta > $what installation completed.$reset"
echo
